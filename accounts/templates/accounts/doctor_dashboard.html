{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doctor Appointments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    function loadDoctorAppointments() {
      fetch("{% url 'appointments:doctor' %}", { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("appointmentsBody");
          tbody.innerHTML = "";

          if (data.error) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-danger py-3">${data.error}</td></tr>`;
            return;
          }

          if (!data.appointments || data.appointments.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-muted py-3">No appointments found.</td></tr>`;
            return;
          }

          data.appointments.forEach(app => {
            let statusBadge = "";
            if (app.status === "pending") statusBadge = `<span class="badge bg-warning text-dark">Pending</span>`;
            else if (app.status === "confirmed") statusBadge = `<span class="badge bg-success">Confirmed</span>`;
            else if (app.status === "cancelled") statusBadge = `<span class="badge bg-danger">Cancelled</span>`;
            else if (app.status === "completed") statusBadge = `<span class="badge bg-secondary">Completed</span>`;

            let actions = "";
            if (app.status === "pending") {
              actions = `
                <button class="btn btn-success btn-sm me-2" onclick="updateStatus(${app.id}, 'confirmed')">Confirm</button>
                <button class="btn btn-danger btn-sm" onclick="updateStatus(${app.id}, 'cancelled')">Cancel</button>
              `;
            } else if (app.status === "confirmed") {
              actions = `<button class="btn btn-outline-secondary btn-sm" onclick="markCompleted(${app.id})">Mark Completed</button>`;
            } else if (app.status === "completed") {
              actions = `<span class="text-muted">âœ” Completed</span>`;
            } else {
              actions = `<span class="text-muted">No action</span>`;
            }

            tbody.innerHTML += `
              <tr id="row-${app.id}">
                <td>${app.patient}</td>
                <td>${app.date}</td>
                <td>${app.time}</td>
                <td>${statusBadge}</td>
                <td>${actions}</td>
              </tr>
            `;
          });
        })
        .catch(err => {
          document.getElementById("appointmentsBody").innerHTML =
            `<tr><td colspan="5" class="text-danger">âš  Error loading appointments.</td></tr>`;
        });
    }

    async function updateStatus(appointmentId, status) {
      try {
        const response = await fetch(`/appointments/update/${appointmentId}/${status}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        const data = await response.json();
        if (data.success) {
          loadDoctorAppointments();
        } else {
          alert("âš  " + data.message);
        }
      } catch (err) {
        alert("âš  Error updating appointment.");
      }
    }

    async function markCompleted(appointmentId) {
      try {
        const response = await fetch(`/appointments/complete/${appointmentId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        const data = await response.json();
        if (data.success) {
          loadDoctorAppointments();
        } else {
          alert("âš  " + data.message);
        }
      } catch (err) {
        alert("âš  Error marking appointment as completed.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadDoctorAppointments);
  </script>
</head>
<body class="bg-light">
<div class="container py-4">

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm rounded mb-4 px-3">
    <a class="navbar-brand fw-bold text-primary">Doctor Dashboard</a>
    <div class="ms-auto">
      <a href="{% url 'accounts:doctor_reviews' %}" class="btn btn-outline-primary btn-sm me-2">Reviews</a>
      <a href="{% url 'accounts:doctor_profile' %}" class="btn btn-outline-info btn-sm me-2">Profile</a>
      <a href="{% url 'accounts:logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </nav>

  <div class="text-center mb-4">
    <h2 class="fw-bold text-dark">ðŸ“… My Appointments</h2>
    <p class="text-muted">Manage and update your patients' appointments</p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-dark text-center">
          <tr>
            <th>Patient</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="appointmentsBody" class="text-center align-middle">
          <tr>
            <td colspan="5" class="text-muted py-3">Loading appointments...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</body>
</html>