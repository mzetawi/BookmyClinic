<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  {% load static %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    const csrfToken = "{{ csrf_token }}";

    function prepareTime() {
      const timeInput = document.getElementById("timeInput").value;
      const ampm = document.getElementById("ampm").value;
      const hiddenTime = document.getElementById("appointment_time");

      if (timeInput) {
        let [hour, minute] = timeInput.split(":").map(Number);
        if (ampm === "PM" && hour < 12) hour += 12;
        if (ampm === "AM" && hour === 12) hour = 0;
        if (hour < 8 || hour > 16) {
          showMessage("‚ö†Ô∏è Appointment must be between 08:00 AM and 04:00 PM.", "danger");
          return false;
        }
        hiddenTime.value = `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}:00`;
        return true;
      }
      showMessage("‚ö†Ô∏è Please choose a valid time.", "danger");
      return false;
    }

    function showMessage(message, type) {
      const div = document.getElementById("responseMessage");
      div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                       </div>`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("appointmentForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!prepareTime()) return;
        const formData = new FormData(form);
        try {
          const response = await fetch("", {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
            body: formData
          });
          const data = await response.json();
          if (data.success) {
            showMessage("‚úÖ " + data.message, "success");
            form.reset();
          } else {
            showMessage("‚ö†Ô∏è " + data.message, "danger");
          }
        } catch (error) {
          showMessage("‚ö†Ô∏è Something went wrong. Please try again.", "danger");
        }
      });
    });
  </script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-success shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">Book Appointment</span>
    <div>
      <a href="{% url 'accounts:patient_home' %}" class="btn btn-light btn-sm">‚¨Ö Back</a>
      <a href="{% url 'accounts:logout' %}" class="btn btn-danger btn-sm">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <div class="card shadow-lg border-0 rounded-4 p-4">
    <h3 class="text-center text-success mb-4">
      Book Appointment with Dr. {{ doctor.user.full_name }}
    </h3>

    <form id="appointmentForm" method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label fw-bold">üìÖ Date</label>
        <input type="date" name="appointment_date" class="form-control" required 
               min="{{ today|date:'Y-m-d' }}">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">‚è∞ Time</label>
        <div class="d-flex gap-2">
          <input type="time" id="timeInput" class="form-control" required>
          <select id="ampm" class="form-select">
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </div>
        <input type="hidden" name="appointment_time" id="appointment_time">
        <div class="form-text text-muted">Available only between 08:00 AM and 04:00 PM</div>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">üìù Reason</label>
        <textarea name="reason" rows="3" class="form-control" placeholder="Write reason (optional)"></textarea>
      </div>
      <button type="submit" class="btn btn-success w-100 py-2">‚úÖ Book Appointment</button>
    </form>
    <div id="responseMessage" class="mt-3"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>