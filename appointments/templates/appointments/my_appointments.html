{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Appointments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    function loadAppointments() {
      fetch("{% url 'appointments:my' %}", { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("appointmentsBody");
          tbody.innerHTML = "";

          if (!data.appointments || data.appointments.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">No appointments found.</td></tr>`;
            return;
          }

          data.appointments.forEach(app => {
            let statusBadge = "";
            if (app.status === "pending") statusBadge = `<span class="badge bg-warning text-dark">Pending</span>`;
            else if (app.status === "confirmed") statusBadge = `<span class="badge bg-success">Confirmed</span>`;
            else if (app.status === "cancelled") statusBadge = `<span class="badge bg-danger">Cancelled</span>`;
            else if (app.status === "completed") statusBadge = `<span class="badge bg-secondary">Completed</span>`;

            let reviewButton = "";
            if (app.status === "completed") {
              reviewButton = `<button class="btn btn-sm btn-outline-primary" onclick="showReviewForm(${app.doctor_id})">Review</button>`;
            }

            tbody.innerHTML += `
              <tr>
                <td>${app.doctor}</td>
                <td>${app.date}</td>
                <td>${app.time}</td>
                <td>${statusBadge}</td>
                <td>${app.reason || "-"}</td>
                <td id="review-cell-${app.doctor_id}">${reviewButton}</td>
              </tr>
            `;
          });
        })
        .catch(err => {
          document.getElementById("appointmentsBody").innerHTML =
            `<tr><td colspan="6" class="text-danger text-center">‚ö† Error loading appointments.</td></tr>`;
        });
    }

    function showReviewForm(doctorId) {
      const container = document.getElementById("reviewContainer");
      container.innerHTML = `
        <div class="card shadow-sm border-0 rounded-4 mt-3">
          <div class="card-body">
            <h5 class="mb-3">Write a Review for Doctor</h5>
            <label class="form-label">Rating (1-5)</label>
            <select id="reviewRating" class="form-select mb-3">
              <option value="">-- Select Rating --</option>
              <option value="1">‚≠ê 1</option>
              <option value="2">‚≠ê 2</option>
              <option value="3">‚≠ê 3</option>
              <option value="4">‚≠ê 4</option>
              <option value="5">‚≠ê 5</option>
            </select>
            <label class="form-label">Review</label>
            <textarea id="reviewText" class="form-control mb-3" rows="3" placeholder="Write your review..."></textarea>
            <button class="btn btn-primary btn-sm" onclick="submitReview(${doctorId})">Submit Review</button>
            <button class="btn btn-secondary btn-sm" onclick="cancelReview()">Cancel</button>
          </div>
        </div>
      `;
    }

    function cancelReview() {
      document.getElementById("reviewContainer").innerHTML = "";
    }

    async function submitReview(doctorId) {
      const text = document.getElementById("reviewText").value.trim();
      const rating = document.getElementById("reviewRating").value;

      if (!rating) {
        showMessage("‚ö† Please select a rating (1‚Äì5).", "danger");
        return;
      }
      if (!text) {
        showMessage("‚ö† Please write something in the review.", "danger");
        return;
      }

      try {
        const response = await fetch(`/reviews/add/${doctorId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ text, rating })
        });

        const data = await response.json();

        if (data.success) {
          showMessage("‚úÖ " + data.message, "success");
          cancelReview();
          const cell = document.getElementById(`review-cell-${doctorId}`);
          if (cell) {
            cell.innerHTML = `<span class="text-muted">‚úî Reviewed</span>`;
          }
        } else {
          showMessage("‚ö† " + data.message, "danger");
        }
      } catch (err) {
        showMessage("‚ö† Error submitting review.", "danger");
      }
    }

    function showMessage(msg, type) {
      const div = document.getElementById("responseMessage");
      div.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }

    document.addEventListener("DOMContentLoaded", loadAppointments);
  </script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">üìÖ My Appointments</span>
    <div>
      <a href="{% url 'accounts:patient_home' %}" class="btn btn-light btn-sm">‚¨Ö Back</a>
      <a href="{% url 'accounts:logout' %}" class="btn btn-danger btn-sm">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">My Appointments</h4>
    <button class="btn btn-outline-primary btn-sm" onclick="loadAppointments()">üîÑ Refresh</button>
  </div>

  <div id="responseMessage"></div>

  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-dark">
          <tr>
            <th>Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Reason</th>
            <th>Review</th>
          </tr>
        </thead>
        <tbody id="appointmentsBody">
          <tr>
            <td colspan="6" class="text-muted py-3">Loading your appointments...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="reviewContainer"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>